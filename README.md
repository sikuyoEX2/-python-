# 📈 株価監視・売買シグナル通知Webアプリ

**楽天証券かぶミニ対応 2,126銘柄をスクリーニング！**  
トレンドフォロー戦略に基づく売買シグナルを自動検出し、AI分析付きで通知するWebアプリケーションです。

[![Streamlit App](https://static.streamlit.io/badges/streamlit_badge_black_white.svg)](https://streamlit.io/)

---

## 📑 目次

1. [銘柄スクリーナー](#1--銘柄スクリーナー)
2. [AI感情分析](#2--ai感情分析gemini-api)
3. [ポートフォリオ管理](#3--ポートフォリオ管理)
4. [売却アドバイザー](#4--売却アドバイザー)
5. [定期通知システム](#5--定期通知システム)
6. [用語解説ページ](#6--用語解説ページ)
7. [通知機能](#7--通知機能)
8. [シグナル監視](#8--シグナル監視)

---

## 1. 📊 銘柄スクリーナー

### 概要
楽天証券「かぶミニ」対応の**全2,126銘柄**から、トレンドフォロー戦略に合致する銘柄を自動検出するスクリーニング機能です。1株から購入可能な銘柄のみを対象としているため、少額投資に最適です。

### スキャンモード

| モード | 対象銘柄数 | 処理時間（目安） | 用途 |
|--------|-----------|-----------------|------|
| **クイック** | 100銘柄 | 約10秒 | 素早くチェックしたい時 |
| **標準** | 500銘柄 | 約30秒 | 日常的なスクリーニング |
| **拡張** | 1,000銘柄 | 約1分 | より多くの候補を探したい時 |
| **全銘柄** | 2,126銘柄 | 約2分 | 徹底的にスキャンしたい時 |

### 並列処理

スクリーニング速度を最大化するため、マルチスレッド並列処理を採用しています。

- **PC環境**: 50ワーカーで超高速スキャン
- **スマホ環境**: 5ワーカーで安定動作（User-Agentで自動判別）

### テクニカルスコア計算（100点満点）

各銘柄を以下の基準で評価し、スコアリングします。

```
テクニカルスコア（100点満点）
│
├── 🔵 トレンド評価: 40点
│   ├── 価格 > 20EMA > 200EMA（理想的な上昇配置）: +25点
│   ├── 価格が20EMA付近（押し目）: +10点
│   └── 200EMA上向き: +5点
│
├── 🟢 モメンタム評価: 40点
│   ├── RSI 40-60（健全なレンジ）: +20点
│   ├── RSI < 40（売られすぎ = 買いチャンス）: +15点ボーナス
│   └── RSI上昇トレンド: +5点
│
└── 🟡 出来高評価: 20点
    └── 直近出来高が20日平均の1.5倍以上: +20点
```

### 価格ボーナス（少額投資向け）

かぶミニで購入しやすい価格帯の銘柄にボーナスを付与します。

| 株価 | ボーナス |
|------|----------|
| 1,000円未満 | **+10点** |
| 3,000円未満 | **+5点** |
| 5,000円未満 | +2点 |

### ランク分け

統合スコアに基づいて銘柄をランク付けします。

| ランク | スコア | 意味 |
|--------|--------|------|
| **S** | 80点以上 | 最高評価、即検討に値する |
| **A** | 60点以上 | 高評価、詳細分析推奨 |
| **B** | 40点以上 | 中評価、条件次第で検討 |
| **C** | 40点未満 | 低評価、見送り推奨 |

### 使い方

1. 左サイドバーで「スクリーナー」ページを選択
2. 予算設定（最大株価）を調整
3. スキャンモードを選択
4. 「🚀 スクリーニング開始」ボタンをクリック
5. 結果は「買いシグナル」「売りシグナル」「全銘柄」タブで確認

---

## 2. 🤖 AI感情分析（Gemini API）

### 概要
Google News RSSから最新ニュースを取得し、Google Gemini 2.0 Flashで感情分析を行います。テクニカル分析だけでは分からない「市場のムード」を数値化します。

### ニュース取得の仕組み

```
ニュース取得フロー
│
├── 1. yfinance（優先）
│   └── Yahoo Finance USからニュース取得を試行
│
└── 2. Google News RSS（フォールバック）
    └── 日本株の場合はこちらがメイン
    └── 検索クエリ: "{銘柄コード} 株 ニュース"
    └── 日本語ニュースを優先取得（hl=ja&gl=JP）
```

### AI分析プロセス

1. **ニュース取得**: 最新5件のニュースを取得
2. **プロンプト送信**: Gemini APIにニュースタイトルと要約を送信
3. **感情スコア算出**: 0（超悲観）〜 100（超楽観）で評価
4. **理由生成**: なぜそのスコアなのか日本語で1-2文の理由を生成

### レート制限対策

Gemini API無料枠の制限（1分間15リクエスト）に対応するため、以下の対策を実装しています。

| 対策 | 詳細 |
|------|------|
| **待機時間** | 各リクエスト間に12秒の待機 |
| **指数バックオフ** | 429エラー時、4秒→8秒→16秒→32秒と待機時間を倍増 |
| **最大リトライ** | 5回まで自動リトライ |
| **分析数削減** | 上位2銘柄のみ自動分析（時間短縮） |

### 統合スコア計算

テクニカルスコアとAI感情スコアを組み合わせて最終評価を算出します。

```
統合スコア = テクニカルスコア × 0.7 + AI感情スコア × 0.3 + 価格ボーナス
```

### 使い方

1. スクリーニング実行時に自動で上位2銘柄をAI分析
2. または右上の「🤖 AI詳細分析」ボタンで手動実行
3. 結果は各銘柄の「AI:」欄に表示

---

## 3. 💼 ポートフォリオ管理

### 概要
保有銘柄と資金を一元管理し、含み損益をリアルタイムで計算します。2%ルールに基づくポジションサイズ計算も搭載。

### 資金管理機能

| 機能 | 説明 |
|------|------|
| **通貨切替** | 円（JPY）/ ドル（USD）対応 |
| **入金** | 資金の追加を記録 |
| **出金** | 資金の引き出しを記録 |
| **残高表示** | 現在の投資可能資金を表示 |

### 保有銘柄管理

| 機能 | 説明 |
|------|------|
| **銘柄追加** | ティッカー、取得価格、株数を入力して追加 |
| **損切りライン設定** | 各銘柄ごとに損切り価格を設定可能 |
| **売却記録** | 売却時に損益を自動計算 |
| **一括削除** | 保有銘柄をまとめて削除 |

### 損益計算

```
含み損益 = (現在価格 - 取得価格) × 保有株数
損益率 = (現在価格 - 取得価格) / 取得価格 × 100%
```

### ポジションサイズ計算（2%ルール）

1回のトレードで許容するリスクを総資金の2%に制限する計算を自動で行います。

```
許容損失額 = 総資金 × 2%
推奨株数 = 許容損失額 / (エントリー価格 - 損切り価格)
```

### データ永続化

| 環境 | 保存先 |
|------|--------|
| **Streamlit Cloud** | Turso DB（クラウドDB） |
| **ローカル** | `.data/` フォルダ内のJSONファイル |

---

## 4. 🔔 売却アドバイザー

### 概要
保有銘柄の売却タイミングを100点満点でスコアリングし、「いつ売るべきか」を客観的に判断するサポートをします。

### 判定基準と配点

```
売却スコア（100点満点）
│
├── 🔴 損切りライン到達: +100点（即時売却推奨）
│   └── 設定した損切り価格以下になった場合
│
├── 🟠 最高値からの下落率
│   ├── 20%以上下落: +25点
│   ├── 15%以上下落: +20点
│   ├── 10%以上下落: +15点
│   └── 5%以上下落: +10点
│
├── 📉 トレンド転換シグナル: +30点
│   ├── 価格 < 20EMA かつ 20EMA下向き
│   └── Death Cross（20EMAが200EMAを下抜け）
│
├── 📊 RSI指標
│   ├── RSI > 70（過熱感）: +15点
│   ├── RSIピークアウト（70超→下落）: +20点
│   └── RSI < 30（売られすぎ）: -10点（売却非推奨）
│
├── 🕯️ ローソク足パターン
│   ├── 長い上ヒゲ（実体の2倍以上）: +15点
│   └── 陰線包み足: +10点
│
└── 💰 含み損率
    ├── -20%以上: +20点
    ├── -15%以上: +15点
    └── -10%以上: +10点
```

### 推奨アクション

| スコア | 推奨アクション |
|--------|---------------|
| **80点以上** | ⚠️ **緊急売却推奨** - すぐに売却を検討 |
| **60点以上** | 📊 売却検討 - 状況を注視しつつ売却準備 |
| **40点以上** | 👀 要注意 - 継続保有だが警戒レベル引き上げ |
| **40点未満** | ✅ 継続保有 - 現時点で売却の必要なし |

### 使い方

1. 「ポートフォリオ」ページを開く
2. 「🔔 売却判定」タブを選択
3. 「📊 売却判定を実行」ボタンをクリック
4. 保有銘柄ごとにスコアと理由が表示される

---

## 5. ⏰ 定期通知システム

### 概要
毎日決まった時刻に自動でスクリーニングを実行し、おすすめ銘柄をWebhook経由で通知します。

### スケジュール

| 時刻 | 名称 | 内容 |
|------|------|------|
| **8:00** | 朝スキャン | 市場オープン前に買いチャンス銘柄をスキャン |
| **15:15** | 午後スキャン | 大引け後に本日の動きを分析 |

### 通知内容

```
🔍 **本日のおすすめ銘柄 TOP2**

1. [A] 7203.T (トヨタ自動車)
   ¥2,500 / RSI: 45.2 / スコア: 82.5

2. [B] 9984.T (ソフトバンクグループ)
   ¥5,800 / RSI: 38.7 / スコア: 75.3
```

### AI分析オプション

定期スキャン時にもAI感情分析を実行するかどうかを設定できます。

- **有効時**: 上位2銘柄にAI分析を実行（約30秒追加）
- **無効時**: テクニカルスコアのみで判定（高速）

### 制限事項

> ⚠️ **Streamlit Cloudの制限**  
> バックグラウンドでのスケジュール実行はサポートされていません。  
> アプリがブラウザで開かれている間のみ、定期スキャンが動作します。
>
> 本格的なバックグラウンド実行には、以下の代替手段を検討してください：
> - GitHub Actions（Cronジョブ）
> - Railway / Render（常時起動）
> - ローカルPC（監視スクリプト）

### 手動実行

「今すぐスキャン実行」ボタンで、時刻に関係なく即座にスキャンを実行できます。

---

## 6. 📖 用語解説ページ

### 概要
投資初心者向けに、テクニカル分析で使用される用語を図表付きで分かりやすく解説するページです。

### 解説項目

| カテゴリ | 項目 |
|----------|------|
| **移動平均線** | EMA（指数平滑移動平均線）、SMA（単純移動平均線）、ゴールデンクロス、デッドクロス |
| **オシレーター** | RSI（相対力指数）、ダイバージェンス、オーバーボート/オーバーソールド |
| **ローソク足** | ピンバー（上ヒゲ/下ヒゲ）、包み足（陽線/陰線）、十字線、マルボズ |
| **トレンド** | 上昇トレンド、下降トレンド、レンジ相場、押し目買い、戻り売り |
| **リスク管理** | 損切り（ストップロス）、利確（テイクプロフィット）、リスクリワード比、2%ルール |

### 図表による解説

各用語には以下の要素を含みます：

- **定義**: 用語の意味を簡潔に説明
- **計算式**: 該当する場合は計算式を明示
- **チャート例**: Plotlyによるインタラクティブなサンプルチャート
- **実践的な使い方**: 実際のトレードでどう活用するか

### 使い方

1. 左サイドバーで「用語解説」ページを選択
2. カテゴリを選択
3. 知りたい用語をクリックして詳細を確認

---

## 7. 🔔 通知機能

### 概要
シグナル発生時に各種プラットフォームへリアルタイム通知を送信します。

### 対応プラットフォーム

| プラットフォーム | 設定方法 | 特徴 |
|-----------------|----------|------|
| **Discord** | Webhook URL | サーバー全体への通知が可能 |
| **LINE** | LINE Notify トークン | スマホへのプッシュ通知 |
| **ブラウザ** | 通知許可のみ | PC作業中に便利 |

### Discord Webhook設定

1. Discordでサーバーを開く
2. 「サーバー設定」→「連携サービス」→「ウェブフック」
3. 「新しいウェブフック」をクリック
4. 名前を設定（例: 株価通知Bot）
5. 通知を送りたいチャンネルを選択
6. 「ウェブフックURLをコピー」
7. アプリのサイドバー「通知設定」にURLを貼り付け

### LINE Notify設定

1. https://notify-bot.line.me/ にアクセス
2. LINEアカウントでログイン
3. 「マイページ」→「トークンを発行する」
4. トークン名を入力（例: 株価通知）
5. 通知を送る先を選択
6. 「発行する」をクリック
7. 表示されたトークンをアプリに貼り付け

### 通知タイミング

| イベント | 通知内容 |
|----------|----------|
| **買いシグナル発生** | 銘柄名、現在価格、トリガー条件 |
| **売りシグナル発生** | 銘柄名、現在価格、トリガー条件 |
| **損切りライン到達** | 緊急アラート |
| **定期スキャン完了** | おすすめ銘柄TOP2 |

### 通知クールダウン

同じ銘柄への連続通知を防ぐため、**30分間のクールダウン**を設けています。

---

## 8. 📡 シグナル監視

### 概要
登録した銘柄（ウォッチリスト）をリアルタイムで監視し、シグナル発生時に通知します。

### ウォッチリスト機能

| 機能 | 説明 |
|------|------|
| **銘柄追加** | ティッカーを入力して追加 |
| **銘柄削除** | 不要な銘柄を削除 |
| **一括分析** | 登録銘柄を一括でシグナル判定 |
| **永続化** | Turso DB / JSONで保存（セッション間で維持） |

### シグナル判定ロジック

| 条件 | 買いシグナル | 売りシグナル |
|------|-------------|-------------|
| **環境認識** | 終値 > 200EMA（日足・15分足両方） | 終値 < 200EMA |
| **セットアップ** | 価格が20EMA付近（±2%以内） or RSI < 40 | 価格が20EMA付近 or RSI > 60 |
| **トリガー** | 下ヒゲピンバー or 陽線包み足 | 上ヒゲピンバー or 陰線包み足 |

### チャート表示

シグナル発生時にはPlotlyによるインタラクティブチャートで以下を表示：

- ローソク足
- 20EMA / 200EMA
- RSI（サブチャート）
- シグナルマーカー（🔵買い / 🔴売り）
- リスクリワード計算（エントリー・損切り・利確ライン）

---

## 📁 ファイル構成

```
-python-/
│
├── 📱 メインアプリケーション
│   ├── app.py                 # Streamlitメインアプリ
│   ├── screener.py            # 銘柄スクリーナー（2126銘柄）
│   ├── portfolio_manager.py   # ポートフォリオ・資金管理
│   ├── sell_advisor.py        # 売却判定アドバイザー
│   ├── scheduled_tasks.py     # 定期通知スケジューラー
│   └── glossary.py            # 初心者向け用語解説
│
├── 📊 コア機能モジュール
│   ├── data_fetcher.py        # yfinanceデータ取得（5分キャッシュ）
│   ├── database.py            # 永続化（Turso/JSON）
│   ├── indicators.py          # EMA, RSI計算
│   ├── patterns.py            # ローソク足パターン判定
│   ├── signals.py             # シグナル判定ロジック
│   └── chart.py               # Plotlyチャート生成
│
├── 🔧 ユーティリティ
│   ├── sentiment.py           # AI感情分析（Gemini + Google News）
│   ├── notifications.py       # 通知機能（Discord/LINE/ブラウザ）
│   ├── device_utils.py        # デバイス判別（スマホ/PC）
│   ├── ml_engine.py           # 機械学習エンジン（実験的）
│   └── monitor.py             # GitHub Actions用監視スクリプト
│
├── ⚙️ 設定ファイル
│   ├── .streamlit/
│   │   └── secrets.toml       # APIキー等（.gitignore必須）
│   ├── .data/                 # ローカル永続化データ
│   ├── requirements.txt       # 依存関係
│   └── .gitignore             # Git除外設定
│
└── 📄 ドキュメント
    └── README.md              # このファイル
```

---

## 🚀 クイックスタート

### ローカル実行

```powershell
# 1. 依存関係インストール
cd d:\デスクトップ\python-株\-python-
python -m pip install -r requirements.txt

# 2. アプリ起動
python -m streamlit run app.py
```

ブラウザで `http://localhost:8501` が自動的に開きます。

### Streamlit Cloud デプロイ

1. GitHubにリポジトリをPush
2. [Streamlit Cloud](https://streamlit.io/cloud) でアプリを作成
3. **Settings → Secrets** に以下を設定:

```toml
# データ永続化（必須）
TURSO_DATABASE_URL = "libsql://your-database.turso.io"
TURSO_AUTH_TOKEN = "your_token_here"

# AI分析（オプション）
GEMINI_API_KEY = "your_gemini_api_key"
```

---

## ⚙️ 設定ガイド

### Turso DB（データ永続化）

Streamlit Cloudでポートフォリオ・資金データを永続化するために必要です。

1. **アカウント作成**: https://turso.tech/ で無料登録
2. **データベース作成**:
   ```bash
   turso db create stock-app
   turso db show stock-app --url      # URLをコピー
   turso db tokens create stock-app   # トークンをコピー
   ```
3. **Streamlit Cloud Secretsに設定**

### Gemini API（AI分析）

ニュース感情分析を有効にするために必要です。

1. **APIキー取得**: https://aistudio.google.com/app/apikey
2. **Streamlit Cloud Secretsに設定**

> ⚠️ **重要**: APIキーは絶対に公開リポジトリにコミットしないでください。  
> GitHubが自動スキャンしており、検出されると即座に無効化されます。

---

## 🔧 技術スタック

| レイヤー | 技術 |
|----------|------|
| フレームワーク | **Streamlit** |
| データ取得 | yfinance（5分キャッシュ） |
| チャート | Plotly（インタラクティブ） |
| 指標計算 | pandas / numpy |
| AI分析 | Google Gemini 2.0 Flash |
| ニュース取得 | Google News RSS |
| データ永続化 | Turso (クラウド) / JSON (ローカル) |
| 並列処理 | concurrent.futures.ThreadPoolExecutor |

---

## ⚠️ 注意事項

- このツールは**分析・監視用**であり、自動売買機能はありません
- **投資判断は自己責任**で行ってください
- yfinanceの制限により、15分足は直近5日分のみ取得可能です
- Gemini API無料枠には**1分間15リクエスト**の制限があります
- 定期通知はStreamlit Cloudの仕様上、**アプリがブラウザで開かれている間のみ**動作します

---

## 📝 更新履歴

| 日付 | 変更内容 |
|------|----------|
| 2026-01-17 | AI感情分析（Gemini 2.0 Flash）、Google News RSS対応 |
| 2026-01-17 | 定期通知システム（8:00 / 15:15）追加 |
| 2026-01-17 | 売却アドバイザー機能追加 |
| 2026-01-17 | スクリーナー並列処理50ワーカー対応 |
| 2026-01-16 | デバイス判別モジュール追加、並列処理最適化 |
| 2026-01-16 | Turso/JSONハイブリッド永続化 |
| 2026-01-16 | APIキャッシュ追加（5分TTL） |
| 2026-01-15 | スクリーナー追加（2126銘柄） |
| 2026-01-15 | ポートフォリオ管理追加 |
| 2026-01-15 | 初期リリース |

---

## 📄 ライセンス

MIT License

---

## 🙋 サポート

問題が発生した場合は、GitHubのIssuesでお知らせください。
