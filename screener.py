"""
éŠ˜æŸ„ã‚¹ã‚¯ãƒªãƒ¼ãƒŠãƒ¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
æ¥½å¤©è¨¼åˆ¸ã‹ã¶ãƒŸãƒ‹å¯¾å¿œéŠ˜æŸ„ã‹ã‚‰æ¡ä»¶ã«åˆã†éŠ˜æŸ„ã‚’æ¤œå‡º
"""
import streamlit as st
import pandas as pd
import yfinance as yf
from typing import List, Dict, Optional
from concurrent.futures import ThreadPoolExecutor, as_completed
import time

# æ¥½å¤©è¨¼åˆ¸ã‹ã¶ãƒŸãƒ‹å¯¾å¿œéŠ˜æŸ„ï¼ˆPDFã‹ã‚‰æŠ½å‡ºã—ãŸå…¨2126éŠ˜æŸ„ï¼‰
RAKUTEN_MINI_STOCKS = [
    "1301.T", "1332.T", "1333.T", "1375.T", "1377.T", "1379.T", "1407.T", "1414.T", "1417.T", "1418.T",
    "1419.T", "1429.T", "1434.T", "1435.T", "1447.T", "1515.T", "1518.T", "1605.T", "1662.T", "1663.T",
    "1712.T", "1716.T", "1717.T", "1719.T", "1720.T", "1721.T", "1723.T", "1726.T", "1762.T", "1766.T",
    "1775.T", "1780.T", "1786.T", "1801.T", "1802.T", "1803.T", "1808.T", "1811.T", "1812.T", "1813.T",
    "1814.T", "1815.T", "1820.T", "1821.T", "1822.T", "1826.T", "1827.T", "1833.T", "1835.T", "1844.T",
    "1847.T", "1852.T", "1860.T", "1861.T", "1870.T", "1871.T", "1878.T", "1879.T", "1882.T", "1884.T",
    "1885.T", "1887.T", "1888.T", "1890.T", "1893.T", "1898.T", "1899.T", "1909.T", "1911.T", "1914.T",
    "1921.T", "1925.T", "1926.T", "1928.T", "1929.T", "1930.T", "1934.T", "1938.T", "1939.T", "1941.T",
    "1942.T", "1944.T", "1945.T", "1946.T", "1949.T", "1950.T", "1951.T", "1952.T", "1959.T", "1961.T",
    "1963.T", "1964.T", "1967.T", "1968.T", "1969.T", "1972.T", "1973.T", "1975.T", "1976.T", "1979.T",
    "1980.T", "1982.T", "2001.T", "2002.T", "2003.T", "2004.T", "2009.T", "2053.T", "2060.T", "2107.T",
    "2108.T", "2109.T", "2112.T", "2117.T", "2121.T", "2124.T", "2127.T", "2130.T", "2138.T", "2146.T",
    "2148.T", "2150.T", "2153.T", "2154.T", "2157.T", "2158.T", "2160.T", "2162.T", "2163.T", "2168.T",
    "2169.T", "2170.T", "2173.T", "2175.T", "2180.T", "2181.T", "2183.T", "2193.T", "2198.T", "2201.T",
    "2206.T", "2208.T", "2209.T", "2211.T", "2212.T", "2215.T", "2217.T", "2220.T", "2222.T", "2229.T",
    "2264.T", "2266.T", "2267.T", "2269.T", "2270.T", "2281.T", "2282.T", "2288.T", "2292.T", "2294.T",
    "2296.T", "2301.T", "2305.T", "2307.T", "2317.T", "2326.T", "2327.T", "2329.T", "2331.T", "2337.T",
    "2353.T", "2354.T", "2359.T", "2371.T", "2372.T", "2374.T", "2375.T", "2378.T", "2379.T", "2384.T",
    "2389.T", "2391.T", "2393.T", "2395.T", "2397.T", "2410.T", "2413.T", "2418.T", "2428.T", "2429.T",
    "2432.T", "2433.T", "2435.T", "2438.T", "2445.T", "2461.T", "2462.T", "2469.T", "2471.T", "2475.T",
    "2477.T", "2479.T", "2484.T", "2488.T", "2489.T", "2491.T", "2492.T", "2497.T", "2501.T", "2502.T",
    "2503.T", "2531.T", "2533.T", "2540.T", "2579.T", "2585.T", "2587.T", "2590.T", "2593.T", "2594.T",
    "2602.T", "2607.T", "2613.T", "2652.T", "2659.T", "2664.T", "2670.T", "2674.T", "2678.T", "2681.T",
    "2685.T", "2692.T", "2695.T", "2698.T", "2700.T", "2702.T", "2705.T", "2715.T", "2726.T", "2730.T",
    "2733.T", "2734.T", "2735.T", "2737.T", "2742.T", "2749.T", "2752.T", "2753.T", "2760.T", "2764.T",
    "2767.T", "2768.T", "2780.T", "2782.T", "2784.T", "2788.T", "2790.T", "2791.T", "2792.T", "2801.T",
    "2802.T", "2804.T", "2809.T", "2810.T", "2811.T", "2813.T", "2815.T", "2820.T", "2871.T", "2874.T",
    "2875.T", "2882.T", "2884.T", "2892.T", "2897.T", "2908.T", "2910.T", "2914.T", "2915.T", "2918.T",
    "2927.T", "2929.T", "2930.T", "2931.T", "2933.T", "2935.T", "2970.T", "2975.T", "2980.T", "2982.T",
    "2986.T", "3001.T", "3002.T", "3003.T", "3023.T", "3028.T", "3030.T", "3031.T", "3034.T", "3035.T",
    "3036.T", "3038.T", "3040.T", "3046.T", "3048.T", "3050.T", "3053.T", "3064.T", "3073.T", "3076.T",
    "3082.T", "3086.T", "3087.T", "3088.T", "3091.T", "3092.T", "3093.T", "3097.T", "3099.T", "3101.T",
    "3103.T", "3104.T", "3105.T", "3106.T", "3107.T", "3110.T", "3116.T", "3132.T", "3134.T", "3139.T",
    "3141.T", "3148.T", "3150.T", "3151.T", "3153.T", "3156.T", "3159.T", "3167.T", "3168.T", "3175.T",
    "3176.T", "3179.T", "3180.T", "3182.T", "3185.T", "3186.T", "3187.T", "3191.T", "3193.T", "3196.T",
    "3197.T", "3198.T", "3199.T", "3201.T", "3205.T", "3221.T", "3222.T", "3231.T", "3232.T", "3236.T",
    "3245.T", "3252.T", "3254.T", "3271.T", "3276.T", "3284.T", "3288.T", "3289.T", "3291.T", "3294.T",
    "3299.T", "3302.T", "3315.T", "3319.T", "3321.T", "3328.T", "3333.T", "3341.T", "3349.T", "3350.T",
    "3355.T", "3360.T", "3371.T", "3374.T", "3382.T", "3387.T", "3388.T", "3391.T", "3393.T", "3395.T",
    "3397.T", "3399.T", "3401.T", "3402.T", "3405.T", "3407.T", "3415.T", "3416.T", "3421.T", "3431.T",
    "3433.T", "3434.T", "3436.T", "3440.T", "3443.T", "3445.T", "3446.T", "3447.T", "3452.T", "3454.T",
    "3457.T", "3458.T", "3465.T", "3475.T", "3479.T", "3480.T", "3482.T", "3486.T", "3489.T", "3491.T",
    "3501.T", "3526.T", "3529.T", "3538.T", "3539.T", "3543.T", "3546.T", "3547.T", "3548.T", "3549.T",
    "3551.T", "3553.T", "3558.T", "3561.T", "3562.T", "3563.T", "3565.T", "3569.T", "3591.T", "3593.T",
    "3608.T", "3611.T", "3612.T", "3623.T", "3626.T", "3632.T", "3633.T", "3635.T", "3636.T", "3641.T",
    "3649.T", "3652.T", "3653.T", "3655.T", "3656.T", "3657.T", "3659.T", "3660.T", "3661.T", "3662.T",
    "3663.T", "3665.T", "3666.T", "3667.T", "3668.T", "3672.T", "3673.T", "3675.T", "3676.T", "3678.T",
    "3679.T", "3680.T", "3681.T", "3683.T", "3687.T", "3688.T", "3692.T", "3694.T", "3696.T", "3697.T",
    "3708.T", "3719.T", "3723.T", "3738.T", "3741.T", "3747.T", "3750.T", "3760.T", "3762.T", "3765.T",
    "3769.T", "3771.T", "3772.T", "3773.T", "3774.T", "3776.T", "3778.T", "3779.T", "3788.T", "3791.T",
    "3798.T", "3807.T", "3817.T", "3834.T", "3835.T", "3836.T", "3837.T", "3843.T", "3844.T", "3853.T",
    "3854.T", "3857.T", "3858.T", "3861.T", "3863.T", "3864.T", "3865.T", "3877.T", "3880.T", "3891.T",
    "3896.T", "3900.T", "3901.T", "3902.T", "3903.T", "3909.T", "3911.T", "3912.T", "3914.T", "3915.T",
    "3916.T", "3921.T", "3922.T", "3923.T", "3924.T", "3925.T", "3926.T", "3927.T", "3932.T", "3933.T",
    "3937.T", "3939.T", "3941.T", "3946.T", "3948.T", "3950.T", "3951.T", "3962.T", "3963.T", "3964.T",
    "3968.T", "3969.T", "3978.T", "3981.T", "3983.T", "3984.T", "3989.T", "3990.T", "3992.T", "3993.T",
    "3994.T", "3996.T", "3998.T", "4004.T", "4005.T", "4008.T", "4015.T", "4017.T", "4021.T", "4022.T",
    "4023.T", "4025.T", "4026.T", "4027.T", "4028.T", "4041.T", "4042.T", "4043.T", "4044.T", "4045.T",
    "4046.T", "4047.T", "4051.T", "4053.T", "4055.T", "4056.T", "4058.T", "4060.T", "4061.T", "4062.T",
    "4063.T", "4064.T", "4071.T", "4072.T", "4078.T", "4080.T", "4082.T", "4088.T", "4091.T", "4092.T",
    "4093.T", "4095.T", "4097.T", "4099.T", "4100.T", "4109.T", "4112.T", "4113.T", "4114.T", "4116.T",
    "4118.T", "4125.T", "4151.T", "4167.T", "4170.T", "4175.T", "4176.T", "4177.T", "4180.T", "4182.T",
    "4183.T", "4186.T", "4187.T", "4188.T", "4189.T", "4192.T", "4193.T", "4194.T", "4202.T", "4203.T",
    "4204.T", "4205.T", "4206.T", "4208.T", "4212.T", "4216.T", "4218.T", "4220.T", "4221.T", "4228.T",
    "4229.T", "4231.T", "4235.T", "4238.T", "4246.T", "4248.T", "4249.T", "4251.T", "4258.T", "4259.T",
    "4265.T", "4272.T", "4274.T", "4275.T", "4286.T", "4290.T", "4293.T", "4298.T", "4301.T", "4307.T",
    "4308.T", "4310.T", "4316.T", "4318.T", "4319.T", "4320.T", "4323.T", "4324.T", "4326.T", "4331.T",
    "4337.T", "4343.T", "4344.T", "4345.T", "4347.T", "4350.T", "4362.T", "4368.T", "4369.T", "4371.T",
    "4373.T", "4374.T", "4375.T", "4377.T", "4382.T", "4384.T", "4385.T", "4386.T", "4388.T", "4396.T",
    "4397.T", "4401.T", "4403.T", "4404.T", "4406.T", "4410.T", "4412.T", "4413.T", "4414.T", "4419.T",
    "4420.T", "4424.T", "4425.T", "4427.T", "4429.T", "4431.T", "4432.T", "4433.T", "4434.T", "4436.T",
    "4438.T", "4441.T", "4442.T", "4443.T", "4446.T", "4448.T", "4449.T", "4452.T", "4461.T", "4462.T",
    "4463.T", "4471.T", "4475.T", "4476.T", "4477.T", "4478.T", "4479.T", "4480.T", "4481.T", "4483.T",
    "4484.T", "4485.T", "4490.T", "4493.T", "4495.T", "4498.T", "4499.T", "4502.T", "4503.T", "4506.T",
    "4507.T", "4516.T", "4519.T", "4521.T", "4523.T", "4526.T", "4527.T", "4528.T", "4530.T", "4534.T",
    "4536.T", "4538.T", "4540.T", "4543.T", "4544.T", "4547.T", "4548.T", "4549.T", "4551.T", "4552.T",
    "4553.T", "4554.T", "4559.T", "4563.T", "4565.T", "4568.T", "4569.T", "4571.T", "4572.T", "4574.T",
    "4577.T", "4578.T", "4579.T", "4582.T", "4587.T", "4588.T", "4592.T", "4593.T", "4595.T", "4599.T",
    "4611.T", "4612.T", "4613.T", "4617.T", "4619.T", "4620.T", "4626.T", "4631.T", "4633.T", "4634.T",
    "4641.T", "4651.T", "4657.T", "4658.T", "4661.T", "4662.T", "4664.T", "4665.T", "4666.T", "4668.T",
    "4671.T", "4674.T", "4676.T", "4678.T", "4680.T", "4681.T", "4684.T", "4686.T", "4687.T", "4689.T",
    "4694.T", "4704.T", "4707.T", "4712.T", "4714.T", "4716.T", "4719.T", "4722.T", "4725.T", "4732.T",
    "4733.T", "4743.T", "4745.T", "4746.T", "4751.T", "4763.T", "4765.T", "4767.T", "4768.T", "4776.T",
    "4783.T", "4792.T", "4801.T", "4811.T", "4812.T", "4813.T", "4816.T", "4819.T", "4820.T", "4825.T",
    "4826.T", "4828.T", "4829.T", "4832.T", "4839.T", "4847.T", "4848.T", "4849.T", "4880.T", "4882.T",
    "4883.T", "4884.T", "4886.T", "4887.T", "4889.T", "4901.T", "4902.T", "4911.T", "4912.T", "4914.T",
    "4917.T", "4919.T", "4922.T", "4923.T", "4927.T", "4928.T", "4931.T", "4933.T", "4934.T", "4936.T",
    "4951.T", "4956.T", "4958.T", "4966.T", "4967.T", "4968.T", "4970.T", "4971.T", "4972.T", "4973.T",
    "4974.T", "4975.T", "4977.T", "4978.T", "4979.T", "4980.T", "4985.T", "4992.T", "4996.T", "4997.T",
    "4998.T", "5009.T", "5010.T", "5011.T", "5013.T", "5017.T", "5018.T", "5019.T", "5020.T", "5021.T",
    "5027.T", "5032.T", "5033.T", "5036.T", "5074.T", "5076.T", "5101.T", "5105.T", "5108.T", "5110.T",
    "5121.T", "5122.T", "5142.T", "5184.T", "5185.T", "5186.T", "5191.T", "5192.T", "5195.T", "5201.T",
    "5202.T", "5204.T", "5208.T", "5210.T", "5214.T", "5218.T", "5232.T", "5233.T", "5253.T", "5258.T",
    "5259.T", "5261.T", "5262.T", "5269.T", "5273.T", "5284.T", "5285.T", "5288.T", "5290.T", "5301.T",
    "5302.T", "5310.T", "5331.T", "5332.T", "5333.T", "5334.T", "5344.T", "5351.T", "5352.T", "5357.T",
    "5384.T", "5388.T", "5393.T", "5401.T", "5406.T", "5408.T", "5410.T", "5411.T", "5423.T", "5440.T",
    "5444.T", "5445.T", "5449.T", "5451.T", "5461.T", "5463.T", "5464.T", "5471.T", "5480.T", "5481.T",
    "5482.T", "5541.T", "5563.T", "5602.T", "5603.T", "5612.T", "5631.T", "5632.T", "5659.T", "5698.T",
    "5702.T", "5703.T", "5706.T", "5707.T", "5711.T", "5713.T", "5714.T", "5715.T", "5726.T", "5727.T",
    "5741.T", "5757.T", "5759.T", "5801.T", "5802.T", "5803.T", "5805.T", "5816.T", "5821.T", "5830.T",
    "5831.T", "5832.T", "5842.T", "5844.T", "5845.T", "5851.T", "5852.T", "5857.T", "5889.T", "5892.T",
    "5901.T", "5902.T", "5911.T", "5915.T", "5929.T", "5930.T", "5932.T", "5933.T", "5938.T", "5943.T",
    "5946.T", "5947.T", "5949.T", "5950.T", "5957.T", "5958.T", "5959.T", "5970.T", "5975.T", "5976.T",
    "5981.T", "5982.T", "5985.T", "5986.T", "5988.T", "5989.T", "5991.T", "5992.T", "6005.T", "6013.T",
    "6023.T", "6027.T", "6028.T", "6035.T", "6036.T", "6048.T", "6049.T", "6050.T", "6055.T", "6058.T",
    "6062.T", "6070.T", "6071.T", "6073.T", "6078.T", "6080.T", "6081.T", "6082.T", "6083.T", "6088.T",
    "6089.T", "6094.T", "6095.T", "6096.T", "6098.T", "6099.T", "6101.T", "6103.T", "6104.T", "6113.T",
    "6118.T", "6125.T", "6134.T", "6135.T", "6136.T", "6137.T", "6140.T", "6141.T", "6143.T", "6145.T",
    "6146.T", "6151.T", "6157.T", "6167.T", "6176.T", "6177.T", "6178.T", "6182.T", "6183.T", "6184.T",
    "6191.T", "6194.T", "6196.T", "6197.T", "6199.T", "6200.T", "6201.T", "6203.T", "6209.T", "6210.T",
    "6222.T", "6224.T", "6226.T", "6231.T", "6232.T", "6235.T", "6237.T", "6238.T", "6239.T", "6240.T",
    "6245.T", "6247.T", "6250.T", "6254.T", "6255.T", "6257.T", "6258.T", "6262.T", "6264.T", "6266.T",
    "6268.T", "6269.T", "6272.T", "6273.T", "6277.T", "6278.T", "6279.T", "6282.T", "6284.T", "6287.T",
    "6289.T", "6291.T", "6293.T", "6294.T", "6298.T", "6301.T", "6302.T", "6305.T", "6306.T", "6309.T",
    "6310.T", "6315.T", "6317.T", "6322.T", "6323.T", "6324.T", "6326.T", "6328.T", "6330.T", "6331.T",
    "6332.T", "6333.T", "6339.T", "6340.T", "6345.T", "6349.T", "6351.T", "6356.T", "6358.T", "6361.T",
    "6363.T", "6364.T", "6366.T", "6367.T", "6368.T", "6369.T", "6370.T", "6371.T", "6373.T", "6376.T",
    "6378.T", "6379.T", "6381.T", "6383.T", "6387.T", "6390.T", "6395.T", "6406.T", "6407.T", "6412.T",
    "6413.T", "6417.T", "6418.T", "6419.T", "6420.T", "6425.T", "6430.T", "6432.T", "6436.T", "6440.T",
    "6444.T", "6445.T", "6448.T", "6454.T", "6455.T", "6457.T", "6458.T", "6459.T", "6460.T", "6463.T",
    "6464.T", "6465.T", "6470.T", "6471.T", "6472.T", "6473.T", "6474.T", "6479.T", "6480.T", "6481.T",
    "6486.T", "6489.T", "6490.T", "6498.T", "6501.T", "6503.T", "6504.T", "6505.T", "6506.T", "6507.T",
    "6508.T", "6516.T", "6517.T", "6521.T", "6522.T", "6523.T", "6524.T", "6525.T", "6526.T", "6532.T",
    "6533.T", "6535.T", "6538.T", "6539.T", "6544.T", "6547.T", "6550.T", "6551.T", "6552.T", "6560.T",
    "6562.T", "6564.T", "6571.T", "6572.T", "6574.T", "6584.T", "6586.T", "6588.T", "6590.T", "6592.T",
    "6594.T", "6597.T", "6615.T", "6616.T", "6617.T", "6619.T", "6620.T", "6622.T", "6625.T", "6626.T",
    "6627.T", "6629.T", "6630.T", "6632.T", "6634.T", "6638.T", "6640.T", "6643.T", "6644.T", "6645.T",
    "6651.T", "6652.T", "6653.T", "6658.T", "6668.T", "6670.T", "6674.T", "6675.T", "6676.T", "6677.T",
    "6699.T", "6701.T", "6702.T", "6703.T", "6706.T", "6707.T", "6718.T", "6723.T", "6724.T", "6727.T",
    "6728.T", "6730.T", "6736.T", "6737.T", "6740.T", "6741.T", "6742.T", "6744.T", "6745.T", "6750.T",
    "6752.T", "6753.T", "6754.T", "6755.T", "6758.T", "6762.T", "6763.T", "6768.T", "6769.T", "6770.T",
    "6777.T", "6778.T", "6779.T", "6785.T", "6787.T", "6788.T", "6794.T", "6800.T", "6804.T", "6806.T",
    "6807.T", "6809.T", "6810.T", "6814.T", "6817.T", "6820.T", "6823.T", "6832.T", "6834.T", "6841.T",
    "6844.T", "6845.T", "6849.T", "6850.T", "6853.T", "6855.T", "6856.T", "6857.T", "6858.T", "6859.T",
    "6861.T", "6862.T", "6863.T", "6866.T", "6869.T", "6871.T", "6875.T", "6877.T", "6879.T", "6882.T",
    "6890.T", "6899.T", "6902.T", "6904.T", "6905.T", "6908.T", "6914.T", "6915.T", "6920.T", "6923.T",
    "6925.T", "6927.T", "6928.T", "6929.T", "6932.T", "6937.T", "6941.T", "6946.T", "6947.T", "6951.T",
    "6952.T", "6954.T", "6955.T", "6957.T", "6958.T", "6960.T", "6961.T", "6962.T", "6963.T", "6965.T",
    "6966.T", "6971.T", "6973.T", "6976.T", "6981.T", "6986.T", "6988.T", "6995.T", "6996.T", "6997.T",
    "6999.T", "7003.T", "7004.T", "7011.T", "7012.T", "7013.T", "7014.T", "7033.T", "7034.T", "7038.T",
    "7044.T", "7047.T", "7048.T", "7059.T", "7061.T", "7065.T", "7068.T", "7071.T", "7082.T", "7085.T",
    "7088.T", "7092.T", "7094.T", "7095.T", "7096.T", "7102.T", "7105.T", "7122.T", "7128.T", "7130.T",
    "7133.T", "7148.T", "7157.T", "7161.T", "7162.T", "7163.T", "7164.T", "7167.T", "7172.T", "7173.T",
    "7177.T", "7180.T", "7181.T", "7182.T", "7184.T", "7186.T", "7187.T", "7189.T", "7191.T", "7192.T",
    "7198.T", "7199.T", "7201.T", "7202.T", "7203.T", "7205.T", "7211.T", "7212.T", "7220.T", "7222.T",
    "7224.T", "7226.T", "7229.T", "7231.T", "7236.T", "7238.T", "7239.T", "7240.T", "7241.T", "7242.T",
    "7244.T", "7245.T", "7246.T", "7247.T", "7250.T", "7256.T", "7259.T", "7261.T", "7266.T", "7267.T",
    "7269.T", "7270.T", "7271.T", "7272.T", "7276.T", "7278.T", "7279.T", "7280.T", "7282.T", "7283.T",
    "7287.T", "7291.T", "7292.T", "7294.T", "7296.T", "7305.T", "7309.T", "7313.T", "7317.T", "7320.T",
    "7322.T", "7326.T", "7327.T", "7337.T", "7342.T", "7347.T", "7350.T", "7354.T", "7358.T", "7366.T",
    "7367.T", "7370.T", "7373.T", "7374.T", "7379.T", "7380.T", "7381.T", "7383.T", "7384.T", "7389.T",
    "7408.T", "7412.T", "7414.T", "7419.T", "7420.T", "7421.T", "7427.T", "7433.T", "7438.T", "7447.T",
    "7451.T", "7453.T", "7456.T", "7458.T", "7459.T", "7463.T", "7466.T", "7467.T", "7476.T", "7480.T",
    "7482.T", "7483.T", "7494.T", "7504.T", "7508.T", "7510.T", "7512.T", "7513.T", "7516.T", "7518.T",
    "7520.T", "7522.T", "7525.T", "7532.T", "7537.T", "7545.T", "7550.T", "7552.T", "7554.T", "7561.T",
    "7564.T", "7575.T", "7581.T", "7593.T", "7595.T", "7599.T", "7600.T", "7601.T", "7605.T", "7606.T",
    "7607.T", "7608.T", "7609.T", "7611.T", "7613.T", "7616.T", "7630.T", "7637.T", "7638.T", "7646.T",
    "7649.T", "7679.T", "7686.T", "7701.T", "7702.T", "7715.T", "7716.T", "7717.T", "7718.T", "7721.T",
    "7723.T", "7725.T", "7727.T", "7729.T", "7730.T", "7731.T", "7732.T", "7733.T", "7734.T", "7735.T",
    "7739.T", "7740.T", "7741.T", "7743.T", "7744.T", "7745.T", "7746.T", "7747.T", "7751.T", "7752.T",
    "7762.T", "7769.T", "7774.T", "7779.T", "7780.T", "7795.T", "7803.T", "7806.T", "7811.T", "7817.T",
    "7818.T", "7820.T", "7821.T", "7822.T", "7826.T", "7832.T", "7839.T", "7840.T", "7841.T", "7844.T",
    "7846.T", "7856.T", "7860.T", "7864.T", "7867.T", "7868.T", "7874.T", "7888.T", "7906.T", "7908.T",
    "7911.T", "7912.T", "7914.T", "7915.T", "7917.T", "7918.T", "7921.T", "7925.T", "7927.T", "7931.T",
    "7936.T", "7942.T", "7943.T", "7944.T", "7947.T", "7949.T", "7951.T", "7952.T", "7955.T", "7956.T",
    "7958.T", "7965.T", "7966.T", "7970.T", "7971.T", "7972.T", "7974.T", "7976.T", "7979.T", "7981.T",
    "7984.T", "7988.T", "7989.T", "7990.T", "7991.T", "7994.T", "7995.T", "8001.T", "8002.T", "8005.T",
    "8007.T", "8008.T", "8011.T", "8012.T", "8014.T", "8015.T", "8016.T", "8018.T", "8020.T", "8022.T",
    "8023.T", "8029.T", "8031.T", "8032.T", "8035.T", "8037.T", "8043.T", "8050.T", "8051.T", "8053.T",
    "8056.T", "8057.T", "8058.T", "8059.T", "8060.T", "8061.T", "8065.T", "8070.T", "8074.T", "8075.T",
    "8078.T", "8079.T", "8081.T", "8084.T", "8086.T", "8088.T", "8091.T", "8093.T", "8095.T", "8097.T",
    "8098.T", "8101.T", "8103.T", "8111.T", "8113.T", "8114.T", "8117.T", "8125.T", "8127.T", "8129.T",
    "8130.T", "8131.T", "8132.T", "8133.T", "8136.T", "8137.T", "8141.T", "8142.T", "8150.T", "8151.T",
    "8153.T", "8154.T", "8157.T", "8158.T", "8159.T", "8160.T", "8163.T", "8167.T", "8173.T", "8174.T",
    "8179.T", "8185.T", "8194.T", "8198.T", "8200.T", "8203.T", "8214.T", "8217.T", "8218.T", "8219.T",
    "8227.T", "8233.T", "8237.T", "8242.T", "8244.T", "8252.T", "8253.T", "8255.T", "8267.T", "8273.T",
    "8276.T", "8278.T", "8279.T", "8281.T", "8282.T", "8283.T", "8285.T", "8291.T", "8304.T", "8306.T",
    "8308.T", "8309.T", "8316.T", "8331.T", "8334.T", "8336.T", "8337.T", "8338.T", "8341.T", "8343.T",
    "8344.T", "8345.T", "8346.T", "8354.T", "8358.T", "8359.T", "8360.T", "8361.T", "8362.T", "8366.T",
    "8367.T", "8368.T", "8370.T", "8377.T", "8381.T", "8383.T", "8386.T", "8387.T", "8388.T", "8392.T",
    "8393.T", "8395.T", "8399.T", "8410.T", "8411.T", "8418.T", "8424.T", "8425.T", "8439.T", "8473.T",
    "8508.T", "8511.T", "8515.T", "8522.T", "8524.T", "8537.T", "8541.T", "8544.T", "8550.T", "8551.T",
    "8558.T", "8566.T", "8570.T", "8572.T", "8584.T", "8585.T", "8591.T", "8593.T", "8595.T", "8596.T",
    "8600.T", "8601.T", "8609.T", "8613.T", "8614.T", "8616.T", "8622.T", "8624.T", "8628.T", "8630.T",
    "8697.T", "8698.T", "8699.T", "8704.T", "8705.T", "8706.T", "8707.T", "8708.T", "8713.T", "8714.T",
    "8715.T", "8725.T", "8737.T", "8739.T", "8746.T", "8750.T", "8766.T", "8769.T", "8771.T", "8793.T",
    "8795.T", "8798.T", "8801.T", "8802.T", "8803.T", "8804.T", "8818.T", "8830.T", "8841.T", "8844.T",
    "8848.T", "8850.T", "8860.T", "8864.T", "8869.T", "8871.T", "8876.T", "8877.T", "8881.T", "8892.T",
    "8897.T", "8904.T", "8905.T", "8912.T", "8914.T", "8919.T", "8920.T", "8923.T", "8927.T", "8929.T",
    "8931.T", "8934.T", "8935.T", "8999.T", "9001.T", "9003.T", "9005.T", "9006.T", "9007.T", "9008.T",
    "9009.T", "9010.T", "9020.T", "9021.T", "9022.T", "9023.T", "9024.T", "9025.T", "9028.T", "9031.T",
    "9037.T", "9039.T", "9041.T", "9042.T", "9044.T", "9045.T", "9046.T", "9048.T", "9052.T", "9055.T",
    "9057.T", "9058.T", "9064.T", "9065.T", "9066.T", "9067.T", "9068.T", "9069.T", "9070.T", "9072.T",
    "9075.T", "9076.T", "9081.T", "9090.T", "9101.T", "9104.T", "9107.T", "9110.T", "9119.T", "9130.T",
    "9142.T", "9143.T", "9147.T", "9161.T", "9164.T", "9166.T", "9201.T", "9202.T", "9204.T", "9216.T",
    "9229.T", "9232.T", "9233.T", "9246.T", "9247.T", "9252.T", "9260.T", "9262.T", "9267.T", "9268.T",
    "9270.T", "9272.T", "9273.T", "9274.T", "9279.T", "9301.T", "9302.T", "9303.T", "9304.T", "9305.T",
    "9306.T", "9308.T", "9310.T", "9324.T", "9325.T", "9332.T", "9336.T", "9338.T", "9343.T", "9347.T",
    "9364.T", "9368.T", "9369.T", "9380.T", "9381.T", "9384.T", "9386.T", "9401.T", "9404.T", "9409.T",
    "9412.T", "9413.T", "9414.T", "9416.T", "9418.T", "9419.T", "9424.T", "9432.T", "9433.T", "9434.T",
    "9435.T", "9436.T", "9438.T", "9449.T", "9450.T", "9467.T", "9468.T", "9470.T", "9474.T", "9501.T",
    "9502.T", "9503.T", "9504.T", "9505.T", "9506.T", "9507.T", "9508.T", "9509.T", "9511.T", "9513.T",
    "9514.T", "9517.T", "9519.T", "9522.T", "9531.T", "9532.T", "9533.T", "9534.T", "9536.T", "9543.T",
    "9551.T", "9552.T", "9600.T", "9601.T", "9602.T", "9603.T", "9605.T", "9612.T", "9613.T", "9616.T",
    "9619.T", "9621.T", "9622.T", "9627.T", "9628.T", "9629.T", "9632.T", "9658.T", "9663.T", "9672.T",
    "9678.T", "9682.T", "9684.T", "9692.T", "9697.T", "9699.T", "9702.T", "9706.T", "9715.T", "9716.T",
    "9719.T", "9720.T", "9722.T", "9726.T", "9729.T", "9735.T", "9739.T", "9740.T", "9742.T", "9743.T",
    "9744.T", "9746.T", "9749.T", "9755.T", "9757.T", "9759.T", "9760.T", "9761.T", "9763.T", "9765.T",
    "9766.T", "9768.T", "9769.T", "9787.T", "9790.T", "9793.T", "9795.T", "9823.T", "9824.T", "9828.T",
    "9830.T", "9831.T", "9832.T", "9837.T", "9842.T", "9843.T", "9845.T", "9856.T", "9861.T", "9869.T",
    "9880.T", "9882.T", "9887.T", "9888.T", "9889.T", "9900.T", "9902.T", "9928.T", "9930.T", "9932.T",
    "9934.T", "9936.T", "9946.T", "9948.T", "9956.T", "9960.T", "9962.T", "9974.T", "9979.T", "9983.T",
    "9984.T", "9987.T", "9989.T", "9990.T", "9991.T", "9997.T",
]


@st.cache_data(ttl=300)  # 5åˆ†ã‚­ãƒ£ãƒƒã‚·ãƒ¥
def get_stock_data_for_screening(ticker: str) -> Optional[Dict]:
    """
    ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ç”¨ã®æ ªä¾¡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ä»˜ãï¼‰
    """
    try:
        stock = yf.Ticker(ticker)
        
        # åŸºæœ¬æƒ…å ±å–å¾—
        info = stock.info
        current_price = info.get('regularMarketPrice') or info.get('currentPrice')
        
        if not current_price:
            return None
        
        # 15åˆ†è¶³ãƒ‡ãƒ¼ã‚¿å–å¾—
        df_15m = stock.history(period="5d", interval="15m")
        if df_15m.empty or len(df_15m) < 50:
            return None
        
        # 1æ™‚é–“è¶³ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆ4æ™‚é–“è¶³ç”Ÿæˆç”¨ï¼‰
        df_1h = stock.history(period="1mo", interval="1h")
        if df_1h.empty or len(df_1h) < 50:
            return None
        
        # ã‚«ãƒ©ãƒ åã‚’å°æ–‡å­—ã«
        df_15m.columns = [c.lower() for c in df_15m.columns]
        df_1h.columns = [c.lower() for c in df_1h.columns]
        
        # 4æ™‚é–“è¶³ã«å¤‰æ›
        df_4h = df_1h.resample('4h').agg({
            'open': 'first', 'high': 'max', 'low': 'min', 'close': 'last', 'volume': 'sum'
        }).dropna()
        
        return {
            'ticker': ticker,
            'name': info.get('shortName', ticker),
            'current_price': current_price,
            'df_15m': df_15m,
            'df_4h': df_4h
        }
    except Exception as e:
        return None


def analyze_stock(data: Dict) -> Optional[Dict]:
    """
    éŠ˜æŸ„ã‚’åˆ†æã—ã¦ã‚·ã‚°ãƒŠãƒ«ã‚’åˆ¤å®š
    """
    try:
        df_15m = data['df_15m'].copy()
        df_4h = data['df_4h'].copy()
        
        # EMAè¨ˆç®—
        for df in [df_15m, df_4h]:
            df['ema_20'] = df['close'].ewm(span=20, adjust=False).mean()
            df['ema_200'] = df['close'].ewm(span=200, adjust=False).mean()
            
            # RSI
            delta = df['close'].diff()
            gain = delta.where(delta > 0, 0.0)
            loss = (-delta).where(delta < 0, 0.0)
            avg_gain = gain.ewm(span=14, adjust=False).mean()
            avg_loss = loss.ewm(span=14, adjust=False).mean()
            rs = avg_gain / avg_loss
            df['rsi'] = 100 - (100 / (1 + rs))
        
        latest = df_15m.iloc[-1]
        prev = df_15m.iloc[-2]
        latest_4h = df_4h.iloc[-1]
        
        # ãƒˆãƒ¬ãƒ³ãƒ‰åˆ¤å®š
        main_uptrend = latest['close'] > latest['ema_200']
        higher_uptrend = latest_4h['close'] > latest_4h['ema_200']
        main_downtrend = latest['close'] < latest['ema_200']
        higher_downtrend = latest_4h['close'] < latest_4h['ema_200']
        
        # ãƒ”ãƒ³ãƒãƒ¼æ¤œå‡º
        body = abs(latest['close'] - latest['open'])
        lower_wick = min(latest['open'], latest['close']) - latest['low']
        upper_wick = latest['high'] - max(latest['open'], latest['close'])
        
        bullish_pin = body > 0 and lower_wick >= body * 2 and upper_wick < body * 0.5
        bearish_pin = body > 0 and upper_wick >= body * 2 and lower_wick < body * 0.5
        
        # åŒ…ã¿è¶³æ¤œå‡º
        curr_body_high = max(latest['open'], latest['close'])
        curr_body_low = min(latest['open'], latest['close'])
        prev_body_high = max(prev['open'], prev['close'])
        prev_body_low = min(prev['open'], prev['close'])
        
        bullish_engulfing = (prev['close'] < prev['open'] and 
                             latest['close'] > latest['open'] and
                             curr_body_low <= prev_body_low and 
                             curr_body_high >= prev_body_high)
        
        bearish_engulfing = (prev['close'] > prev['open'] and 
                             latest['close'] < latest['open'] and
                             curr_body_low <= prev_body_low and 
                             curr_body_high >= prev_body_high)
        
        # ã‚·ã‚°ãƒŠãƒ«åˆ¤å®š
        signal = None
        trigger = ""
        trend = ""
        
        # è²·ã„ã‚·ã‚°ãƒŠãƒ«
        if main_uptrend and higher_uptrend:
            trend = "ä¸Šæ˜‡ãƒˆãƒ¬ãƒ³ãƒ‰"
            near_ema = abs(latest['close'] - latest['ema_20']) / latest['ema_20'] < 0.01
            rsi_ok = latest['rsi'] < 40
            if near_ema or rsi_ok:
                if bullish_pin:
                    signal = "è²·ã„"
                    trigger = "ä¸‹ãƒ’ã‚²ãƒ”ãƒ³ãƒãƒ¼"
                elif bullish_engulfing:
                    signal = "è²·ã„"
                    trigger = "é™½ç·šåŒ…ã¿è¶³"
        
        # å£²ã‚Šã‚·ã‚°ãƒŠãƒ«
        elif main_downtrend and higher_downtrend:
            trend = "ä¸‹è½ãƒˆãƒ¬ãƒ³ãƒ‰"
            near_ema = abs(latest['close'] - latest['ema_20']) / latest['ema_20'] < 0.01
            rsi_ok = latest['rsi'] > 60
            if near_ema or rsi_ok:
                if bearish_pin:
                    signal = "å£²ã‚Š"
                    trigger = "ä¸Šãƒ’ã‚²ãƒ”ãƒ³ãƒãƒ¼"
                elif bearish_engulfing:
                    signal = "å£²ã‚Š"
                    trigger = "é™°ç·šåŒ…ã¿è¶³"
        else:
            trend = "ãƒ¬ãƒ³ã‚¸"
        
        # ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ…‹ï¼ˆã‚·ã‚°ãƒŠãƒ«ã¯ãªã„ãŒãƒˆãƒ¬ãƒ³ãƒ‰æ–¹å‘ã¯ä¸€è‡´ï¼‰
        setup = ""
        if main_uptrend and higher_uptrend and not signal:
            near_ema = abs(latest['close'] - latest['ema_20']) / latest['ema_20'] < 0.015
            if near_ema or latest['rsi'] < 45:
                setup = "æŠ¼ã—ç›®å¾…ã¡"
        elif main_downtrend and higher_downtrend and not signal:
            near_ema = abs(latest['close'] - latest['ema_20']) / latest['ema_20'] < 0.015
            if near_ema or latest['rsi'] > 55:
                setup = "æˆ»ã‚Šå¾…ã¡"
        
        # === ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆMax 100ç‚¹ï¼‰===
        tech_score = 0
        
        # ãƒˆãƒ¬ãƒ³ãƒ‰è©•ä¾¡ï¼ˆ40ç‚¹æº€ç‚¹ï¼‰
        trend_score = 0
        if latest['close'] > latest['ema_200']:  # Price > 200EMA
            trend_score += 20
        if latest['ema_20'] > latest['ema_200']:  # 20EMA > 200EMA
            trend_score += 20
        
        # ãƒ¢ãƒ¡ãƒ³ã‚¿ãƒ /æŠ¼ã—ç›®è©•ä¾¡ï¼ˆ40ç‚¹æº€ç‚¹ï¼‰
        momentum_score = 0
        rsi = latest['rsi'] or 50
        if 30 <= rsi <= 40:  # å£²ã‚‰ã‚Œã™ããƒ»æŠ¼ã—ç›®ã‚¾ãƒ¼ãƒ³
            momentum_score = 30
        elif rsi < 30:  # æ¥µåº¦ã®å£²ã‚‰ã‚Œã™ã
            momentum_score = 25
        elif 40 < rsi <= 60:  # ä¸­ç«‹
            momentum_score = 20
        elif rsi > 70:  # è²·ã‚ã‚Œã™ã
            momentum_score = 0
        else:
            momentum_score = 10
        
        # å‡ºæ¥é«˜è©•ä¾¡ï¼ˆ20ç‚¹æº€ç‚¹ï¼‰- ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°
        volume_score = 10  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        
        tech_score = trend_score + momentum_score + volume_score
        
        # === ä¾¡æ ¼å€¤ã”ã‚æ„Ÿãƒœãƒ¼ãƒŠã‚¹ï¼ˆMax 10ç‚¹ï¼‰===
        price = data['current_price']
        if price < 1000:
            price_bonus = 10
        elif price < 3000:
            price_bonus = 5
        else:
            price_bonus = 0
        
        # === ãƒ©ãƒ³ã‚¯åˆ¤å®šï¼ˆãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ã®ã¿ã€AIåŠ ç‚¹å‰ï¼‰===
        base_score = tech_score + price_bonus
        if base_score >= 80:
            rank = "S"
        elif base_score >= 60:
            rank = "A"
        elif base_score >= 40:
            rank = "B"
        else:
            rank = "C"
        
        return {
            'ticker': data['ticker'],
            'name': data['name'],
            'price': data['current_price'],
            'trend': trend,
            'rsi': latest['rsi'],
            'signal': signal,
            'trigger': trigger,
            'setup': setup,
            'ema_20_dist': ((latest['close'] - latest['ema_20']) / latest['ema_20']) * 100,
            # æ–°è¦è¿½åŠ 
            'tech_score': tech_score,
            'price_bonus': price_bonus,
            'base_score': base_score,  # AIåŠ ç‚¹å‰ã‚¹ã‚³ã‚¢
            'rank': rank
        }
        
    except Exception as e:
        return None


def is_mobile_device() -> bool:
    """
    ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹ã‹ã©ã†ã‹ã‚’åˆ¤å®š
    Streamlitã§ã¯user-agentã‚’ç›´æ¥å–å¾—ã§ããªã„ãŸã‚ã€
    ç”»é¢å¹…ã‚„ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‹ã‚‰æ¨æ¸¬
    """
    try:
        # Streamlit Cloudã§ã¯st.context.headersã‹ã‚‰User-Agentã‚’å–å¾—å¯èƒ½
        if hasattr(st, 'context') and hasattr(st.context, 'headers'):
            user_agent = st.context.headers.get('User-Agent', '').lower()
            mobile_keywords = ['mobile', 'android', 'iphone', 'ipad', 'ipod', 'webos', 'blackberry']
            return any(keyword in user_agent for keyword in mobile_keywords)
    except:
        pass
    
    # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‹ã‚‰åˆ¤å®šï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•è¨­å®šå¯èƒ½ï¼‰
    return st.session_state.get('is_mobile', False)


def process_single_stock(args):
    """
    1éŠ˜æŸ„ã‚’å‡¦ç†ï¼ˆä¸¦åˆ—å‡¦ç†ç”¨ï¼‰
    """
    ticker, max_price = args
    try:
        data = get_stock_data_for_screening(ticker)
        if not data:
            return None
        
        if data['current_price'] > max_price:
            return None
        
        result = analyze_stock(data)
        return result
    except Exception:
        return None


def screen_stocks_parallel(stock_list: List[str], max_price: float = 10000, 
                           max_workers: int = 10, progress_callback=None) -> List[Dict]:
    """
    éŠ˜æŸ„ã‚’ä¸¦åˆ—ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆPCå‘ã‘é«˜é€Ÿç‰ˆï¼‰
    
    Args:
        stock_list: ã‚¹ã‚­ãƒ£ãƒ³å¯¾è±¡ã®éŠ˜æŸ„ãƒªã‚¹ãƒˆ
        max_price: æœ€å¤§æ ªä¾¡
        max_workers: ä¸¦åˆ—ãƒ¯ãƒ¼ã‚«ãƒ¼æ•°
        progress_callback: é€²æ—ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°
    
    Returns:
        æ¡ä»¶ã«åˆã†éŠ˜æŸ„ã®ãƒªã‚¹ãƒˆ
    """
    results = []
    total = len(stock_list)
    completed = 0
    
    # å¼•æ•°ã®ã‚¿ãƒ—ãƒ«ã‚’ä½œæˆ
    args_list = [(ticker, max_price) for ticker in stock_list]
    
    with ThreadPoolExecutor(max_workers=max_workers) as executor:
        # å…¨ã‚¿ã‚¹ã‚¯ã‚’æŠ•å…¥
        future_to_ticker = {executor.submit(process_single_stock, args): args[0] 
                           for args in args_list}
        
        # å®Œäº†ã—ãŸã‚‚ã®ã‹ã‚‰å‡¦ç†
        for future in as_completed(future_to_ticker):
            completed += 1
            ticker = future_to_ticker[future]
            
            if progress_callback:
                progress_callback(completed, total, ticker)
            
            try:
                result = future.result()
                if result:
                    results.append(result)
            except Exception:
                pass
    
    return results


def screen_stocks(stock_list: List[str] = None, max_price: float = 10000, 
                  progress_callback=None, use_parallel: bool = False, 
                  max_workers: int = 10) -> List[Dict]:
    """
    éŠ˜æŸ„ã‚’ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°
    
    Args:
        stock_list: ã‚¹ã‚­ãƒ£ãƒ³å¯¾è±¡ã®éŠ˜æŸ„ãƒªã‚¹ãƒˆï¼ˆNoneã®å ´åˆã¯å…¨éŠ˜æŸ„ï¼‰
        max_price: æœ€å¤§æ ªä¾¡
        progress_callback: é€²æ—ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°
        use_parallel: ä¸¦åˆ—å‡¦ç†ã‚’ä½¿ç”¨ã™ã‚‹ã‹
        max_workers: ä¸¦åˆ—ãƒ¯ãƒ¼ã‚«ãƒ¼æ•°
    
    Returns:
        æ¡ä»¶ã«åˆã†éŠ˜æŸ„ã®ãƒªã‚¹ãƒˆ
    """
    if stock_list is None:
        stock_list = RAKUTEN_MINI_STOCKS
    
    # ä¸¦åˆ—å‡¦ç†ã‚’ä½¿ç”¨
    if use_parallel:
        return screen_stocks_parallel(stock_list, max_price, max_workers=max_workers, 
                                       progress_callback=progress_callback)
    
    # é€æ¬¡å‡¦ç†ï¼ˆã‚¹ãƒãƒ›å‘ã‘ï¼‰
    results = []
    total = len(stock_list)
    
    for i, ticker in enumerate(stock_list):
        if progress_callback:
            progress_callback(i + 1, total, ticker)
        
        # ãƒ‡ãƒ¼ã‚¿å–å¾—
        data = get_stock_data_for_screening(ticker)
        if not data:
            continue
        
        # ä¾¡æ ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if data['current_price'] > max_price:
            continue
        
        # åˆ†æ
        result = analyze_stock(data)
        if result:
            results.append(result)
        
        # APIåˆ¶é™å¯¾ç­–
        time.sleep(0.3)
    
    return results


def render_screener_page():
    """ã‚¹ã‚¯ãƒªãƒ¼ãƒŠãƒ¼ç”»é¢ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°"""
    # ã‚¿ã‚¤ãƒˆãƒ«ã¨AIåˆ†æãƒœã‚¿ãƒ³ã‚’æ¨ªä¸¦ã³
    title_col, ai_col = st.columns([3, 1])
    with title_col:
        st.title("ğŸ” éŠ˜æŸ„ã‚¹ã‚¯ãƒªãƒ¼ãƒŠãƒ¼")
    with ai_col:
        st.write("")  # ã‚¹ãƒšãƒ¼ã‚µãƒ¼
        if st.button("ğŸ¤– AIè©³ç´°åˆ†æ", use_container_width=True, type="secondary"):
            st.session_state.run_ai_analysis = True
    
    st.markdown("æ¥½å¤©è¨¼åˆ¸ã‹ã¶ãƒŸãƒ‹å¯¾å¿œéŠ˜æŸ„ï¼ˆ2126éŠ˜æŸ„ï¼‰ã‹ã‚‰ã€ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ•ã‚©ãƒ­ãƒ¼æˆ¦ç•¥ã«åˆã†éŠ˜æŸ„ã‚’æ¤œå‡ºã—ã¾ã™ã€‚")
    
    # è¨­å®š
    with st.sidebar:
        st.subheader("ğŸ’° äºˆç®—è¨­å®š")
        max_budget = st.number_input(
            "æœ€å¤§äºˆç®—ï¼ˆå††ï¼‰",
            min_value=10000,
            max_value=1000000,
            value=100000,
            step=10000,
            help="ã‹ã¶ãƒŸãƒ‹ï¼ˆ1æ ªå˜ä½ï¼‰ã§ã®æœ€å¤§è³¼å…¥äºˆç®—"
        )
        
        st.divider()
        
        st.subheader("ğŸ¯ ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°æ¡ä»¶")
        max_price = st.number_input(
            "æœ€å¤§æ ªä¾¡ï¼ˆå††ï¼‰",
            min_value=500,
            max_value=100000,
            value=min(max_budget, 10000),
            step=500
        )
        
        scan_mode = st.radio(
            "ã‚¹ã‚­ãƒ£ãƒ³ãƒ¢ãƒ¼ãƒ‰",
            ["ã‚¯ã‚¤ãƒƒã‚¯ï¼ˆ100éŠ˜æŸ„ï¼‰", "æ¨™æº–ï¼ˆ500éŠ˜æŸ„ï¼‰", "æ‹¡å¼µï¼ˆ1000éŠ˜æŸ„ï¼‰", "å…¨éŠ˜æŸ„ï¼ˆ2126éŠ˜æŸ„ï¼‰"],
            help="éŠ˜æŸ„æ•°ãŒå¤šã„ã»ã©æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™"
        )
        
        show_setup = st.checkbox("ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­ã®éŠ˜æŸ„ã‚‚è¡¨ç¤º", value=True)
        
        st.divider()
        
        # AIåˆ†æã‚ªãƒ—ã‚·ãƒ§ãƒ³
        st.subheader("ğŸ¤– AIè©³ç´°åˆ†æ")
        use_ai = st.checkbox("AIåˆ†æã‚’å®Ÿè¡Œï¼ˆä¸Šä½10ä»¶ï¼‰", 
                            value=st.session_state.get('use_ai_analysis', False),
                            key='use_ai_checkbox',
                            help="ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ã‚¹ã‚³ã‚¢ä¸Šä½éŠ˜æŸ„ã«Gemini APIã§ãƒ‹ãƒ¥ãƒ¼ã‚¹åˆ†æ")
        st.session_state.use_ai_analysis = use_ai
        
        if use_ai:
            st.caption("âš ï¸ Gemini APIã‚­ãƒ¼å¿…è¦ / ç´„40ç§’ã‹ã‹ã‚Šã¾ã™")
        
        st.divider()
        
        # ã‚¹ã‚³ã‚¢èª¬æ˜
        with st.expander("ğŸ“Š ã‚¹ã‚³ã‚¢ã®è¦‹æ–¹"):
            st.markdown("""
            **ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«è©•ä¾¡ï¼ˆ100ç‚¹æº€ç‚¹ï¼‰**
            - ãƒˆãƒ¬ãƒ³ãƒ‰: 40ç‚¹
            - ãƒ¢ãƒ¡ãƒ³ã‚¿ãƒ : 40ç‚¹
            - å‡ºæ¥é«˜: 20ç‚¹
            
            **ä¾¡æ ¼ãƒœãƒ¼ãƒŠã‚¹ï¼ˆ10ç‚¹æº€ç‚¹ï¼‰**
            - 1000å††æœªæº€: +10ç‚¹
            - 3000å††æœªæº€: +5ç‚¹
            
            **AIè©•ä¾¡ï¼ˆ30%é‡ã¿ä»˜ã‘ï¼‰**
            - ãƒ‹ãƒ¥ãƒ¼ã‚¹æ„Ÿæƒ…åˆ†æ
            
            **ãƒ©ãƒ³ã‚¯**: S(80+) / A(60+) / B(40+) / C
            """)
        
        st.caption(f"å¯¾è±¡éŠ˜æŸ„æ•°: {len(RAKUTEN_MINI_STOCKS)}éŠ˜æŸ„")
    
    # ã‚¹ã‚­ãƒ£ãƒ³æ•°ã®æ±ºå®š
    import random
    if scan_mode == "ã‚¯ã‚¤ãƒƒã‚¯ï¼ˆ100éŠ˜æŸ„ï¼‰":
        scan_count = 100
        scan_list = random.sample(RAKUTEN_MINI_STOCKS, min(scan_count, len(RAKUTEN_MINI_STOCKS)))
    elif scan_mode == "æ¨™æº–ï¼ˆ500éŠ˜æŸ„ï¼‰":
        scan_count = 500
        scan_list = random.sample(RAKUTEN_MINI_STOCKS, min(scan_count, len(RAKUTEN_MINI_STOCKS)))
    elif scan_mode == "æ‹¡å¼µï¼ˆ1000éŠ˜æŸ„ï¼‰":
        scan_count = 1000
        scan_list = random.sample(RAKUTEN_MINI_STOCKS, min(scan_count, len(RAKUTEN_MINI_STOCKS)))
    else:
        scan_list = RAKUTEN_MINI_STOCKS
        scan_count = len(scan_list)
    
    # ãƒ‡ãƒã‚¤ã‚¹åˆ¤å®šï¼ˆå‚è€ƒç”¨ã«ä¿æŒã€å°†æ¥ä½¿ã†å¯èƒ½æ€§ã‚ã‚Šï¼‰
    from device_utils import is_mobile_device
    is_mobile = is_mobile_device()
    
    # ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°å®Ÿè¡Œ
    if st.button(f"ğŸš€ ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°é–‹å§‹ï¼ˆ{scan_count}éŠ˜æŸ„ï¼‰", type="primary", use_container_width=True):
        progress_bar = st.progress(0)
        status_text = st.empty()
        
        # ä¸¦åˆ—å‡¦ç†ã®Workersæ•°ï¼ˆã‚¹ãƒãƒ›5ã€PC10ï¼‰
        workers = 5 if is_mobile else 10
        st.success(f"âš¡ ä¸¦åˆ—å‡¦ç†ã§å®Ÿè¡Œï¼ˆWorkers: {workers}ï¼‰")
        
        def update_progress(current, total, ticker):
            progress_bar.progress(current / total)
            status_text.text(f"ã‚¹ã‚­ãƒ£ãƒ³ä¸­: {ticker} ({current}/{total})")
        
        with st.spinner("éŠ˜æŸ„ã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­..."):
            results = screen_stocks(
                stock_list=scan_list, 
                max_price=max_price, 
                progress_callback=update_progress,
                use_parallel=True,  # å¸¸ã«ä¸¦åˆ—å‡¦ç†
                max_workers=workers
            )
        
        progress_bar.empty()
        status_text.empty()
        
        # çµæœã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜
        st.session_state.screening_results = results
        st.session_state.screening_time = pd.Timestamp.now()
    
    # çµæœè¡¨ç¤º
    if 'screening_results' in st.session_state:
        results = st.session_state.screening_results
        scan_time = st.session_state.get('screening_time', '')
        
        st.caption(f"æœ€çµ‚ã‚¹ã‚­ãƒ£ãƒ³: {scan_time}")
        
        # ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ã‚¹ã‚³ã‚¢é †ã«ã‚½ãƒ¼ãƒˆï¼ˆé«˜ã„ã»ã©ä¸Šä½ï¼‰
        if results:
            # base_scoreï¼ˆãƒ†ã‚¯ãƒ‹ã‚«ãƒ«+ä¾¡æ ¼ãƒœãƒ¼ãƒŠã‚¹ï¼‰ã§ã‚½ãƒ¼ãƒˆ
            results = sorted(results, key=lambda x: x.get('base_score', 0), reverse=True)
            st.session_state.screening_results = results
        
        # è²·ã„ã‚·ã‚°ãƒŠãƒ«ã¨å£²ã‚Šã‚·ã‚°ãƒŠãƒ«ã«åˆ†é¡
        buy_signals = [r for r in results if r.get('signal') == 'è²·ã„']
        sell_signals = [r for r in results if r.get('signal') == 'å£²ã‚Š']
        
        # ã‚¿ãƒ–ã§è¡¨ç¤º
        tab1, tab2, tab3 = st.tabs([
            f"ğŸŸ¢ è²·ã„ã‚·ã‚°ãƒŠãƒ« ({len(buy_signals)})",
            f"ğŸ”´ å£²ã‚Šã‚·ã‚°ãƒŠãƒ« ({len(sell_signals)})",
            f"ğŸ“Š å…¨éŠ˜æŸ„ ({len(results)})"
        ])
        
        with tab1:
            if buy_signals:
                st.caption("â€» ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ã‚¹ã‚³ã‚¢é †ï¼ˆé«˜ã„ã»ã©æ¨å¥¨ï¼‰")
                
                # === ãƒˆãƒƒãƒ—5éŠ˜æŸ„ã®è‡ªå‹•AIåˆ†æ ===
                top5 = buy_signals[:5]
                
                # AIåˆ†æçµæœãŒãªã‘ã‚Œã°è‡ªå‹•å®Ÿè¡Œ
                if 'top5_ai_results' not in st.session_state or st.session_state.get('top5_ai_tickers') != [s['ticker'] for s in top5]:
                    try:
                        from sentiment import NewsAnalyzer
                        analyzer = NewsAnalyzer()
                        
                        with st.spinner("ğŸ¤– ãƒˆãƒƒãƒ—5éŠ˜æŸ„ã‚’AIåˆ†æä¸­..."):
                            ai_results = []
                            progress_bar = st.progress(0)
                            
                            for i, stock in enumerate(top5):
                                ticker = stock['ticker']
                                try:
                                    news = analyzer.get_news(ticker)
                                    if news:
                                        score, reason = analyzer.analyze_news(ticker, news[0].get('title', ''))
                                        stock['ai_score'] = score
                                        stock['ai_reason'] = reason
                                        # çµ±åˆã‚¹ã‚³ã‚¢è¨ˆç®—
                                        tech = stock.get('tech_score', 50)
                                        stock['total_score'] = (tech * 0.7) + (score * 0.3) + stock.get('price_bonus', 0)
                                    else:
                                        stock['ai_score'] = 50
                                        stock['ai_reason'] = "ãƒ‹ãƒ¥ãƒ¼ã‚¹ãªã—"
                                        stock['total_score'] = stock.get('base_score', 0)
                                except Exception as e:
                                    stock['ai_score'] = 50
                                    stock['ai_reason'] = f"ã‚¨ãƒ©ãƒ¼: {str(e)[:20]}"
                                    stock['total_score'] = stock.get('base_score', 0)
                                
                                ai_results.append(stock)
                                progress_bar.progress((i + 1) / len(top5))
                                time.sleep(4)  # APIåˆ¶é™å¯¾ç­–
                            
                            progress_bar.empty()
                            # çµ±åˆã‚¹ã‚³ã‚¢ã§å†ã‚½ãƒ¼ãƒˆ
                            ai_results = sorted(ai_results, key=lambda x: x.get('total_score', 0), reverse=True)
                            st.session_state.top5_ai_results = ai_results
                            st.session_state.top5_ai_tickers = [s['ticker'] for s in top5]
                    except ImportError:
                        st.warning("âš ï¸ AIåˆ†æãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“")
                        st.session_state.top5_ai_results = top5
                        st.session_state.top5_ai_tickers = [s['ticker'] for s in top5]
                
                # AIåˆ†æçµæœè¡¨ç¤ºï¼ˆãƒˆãƒƒãƒ—5ï¼‰
                if 'top5_ai_results' in st.session_state:
                    st.success("ğŸ† **AIåˆ†ææ¸ˆã¿ãƒˆãƒƒãƒ—5** (çµ±åˆã‚¹ã‚³ã‚¢ = ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«70% + AI30% + ä¾¡æ ¼ãƒœãƒ¼ãƒŠã‚¹)")
                    for rank, stock in enumerate(st.session_state.top5_ai_results, 1):
                        col1, col2, col3, col4, col5 = st.columns([0.5, 2, 1, 1, 1])
                        with col1:
                            st.write(f"**{rank}**")
                        with col2:
                            rank_badge = stock.get('rank', 'C')
                            st.write(f"**[{rank_badge}] {stock['ticker']}** - {stock['name']}")
                            st.caption(f"AI: {stock.get('ai_reason', 'N/A')}")
                        with col3:
                            st.metric("æ ªä¾¡", f"Â¥{stock['price']:,.0f}")
                        with col4:
                            ai_score = stock.get('ai_score', 50)
                            color = "ğŸŸ¢" if ai_score >= 60 else "ğŸ”´" if ai_score < 40 else "ğŸŸ¡"
                            st.metric("AIæ„Ÿæƒ…", f"{color} {ai_score}")
                        with col5:
                            total = stock.get('total_score', stock.get('base_score', 0))
                            st.metric("çµ±åˆ", f"{total:.1f}ç‚¹")
                    
                    st.divider()
                
                # æ®‹ã‚Šã®éŠ˜æŸ„ã‚’è¡¨ç¤º
                st.markdown("### ãã®ä»–ã®è²·ã„ã‚·ã‚°ãƒŠãƒ«éŠ˜æŸ„")
                for stock in buy_signals:
                    render_stock_card(stock, show_signal=True)
            else:
                st.info("ç¾åœ¨ã€è²·ã„ã‚·ã‚°ãƒŠãƒ«ãŒç™ºç”Ÿã—ã¦ã„ã‚‹éŠ˜æŸ„ã¯ã‚ã‚Šã¾ã›ã‚“")
        
        with tab2:
            if sell_signals:
                st.caption("â€» ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ã‚¹ã‚³ã‚¢é †")
                for stock in sell_signals:
                    render_stock_card(stock, show_signal=True)
            else:
                st.info("ç¾åœ¨ã€å£²ã‚Šã‚·ã‚°ãƒŠãƒ«ãŒç™ºç”Ÿã—ã¦ã„ã‚‹éŠ˜æŸ„ã¯ã‚ã‚Šã¾ã›ã‚“")
        
        with tab3:
            if results:
                st.caption("â€» ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ã‚¹ã‚³ã‚¢é †ï¼ˆé«˜ã„ã»ã©æ¨å¥¨ï¼‰")
                df = pd.DataFrame(results)
                # å¿…è¦ãªã‚«ãƒ©ãƒ ã®ã¿æŠ½å‡ºï¼ˆå­˜åœ¨ç¢ºèªï¼‰
                cols = ['rank', 'ticker', 'name', 'price', 'tech_score', 'price_bonus', 'base_score', 'rsi', 'trend']
                available_cols = [c for c in cols if c in df.columns]
                df = df[available_cols]
                
                # ã‚«ãƒ©ãƒ åå¤‰æ›´
                col_map = {
                    'rank': 'ãƒ©ãƒ³ã‚¯', 'ticker': 'ã‚³ãƒ¼ãƒ‰', 'name': 'éŠ˜æŸ„å', 
                    'price': 'æ ªä¾¡', 'tech_score': 'ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«', 'price_bonus': 'ä¾¡æ ¼ãƒœãƒ¼ãƒŠã‚¹',
                    'base_score': 'ç·åˆã‚¹ã‚³ã‚¢', 'rsi': 'RSI', 'trend': 'ãƒˆãƒ¬ãƒ³ãƒ‰'
                }
                df = df.rename(columns=col_map)
                
                # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                if 'æ ªä¾¡' in df.columns:
                    df['æ ªä¾¡'] = df['æ ªä¾¡'].apply(lambda x: f"Â¥{x:,.0f}")
                if 'RSI' in df.columns:
                    df['RSI'] = df['RSI'].apply(lambda x: f"{x:.1f}" if pd.notna(x) else "-")
                
                st.dataframe(df, use_container_width=True, hide_index=True)
            else:
                st.info("æ¡ä»¶ã«åˆã†éŠ˜æŸ„ãŒã‚ã‚Šã¾ã›ã‚“")
        
        # AIåˆ†æã‚¿ãƒ–ï¼ˆsession_stateã§ç®¡ç†ï¼‰
        if use_ai and results:
            st.divider()
            st.subheader("ğŸ¤– AIè©³ç´°åˆ†æï¼ˆä¸Šä½10ä»¶ï¼‰")
            
            # ä¸Šä½10ä»¶ã‚’æŠ½å‡º
            top_picks = results[:10]
            
            if st.button("ğŸ”¬ AIåˆ†æã‚’å®Ÿè¡Œ", type="secondary"):
                try:
                    from sentiment import SentimentAnalyzer
                    from ml_engine import StockPredictor
                    
                    analyzer = SentimentAnalyzer()
                    predictor = StockPredictor()
                    
                    if not analyzer.is_available():
                        st.error("âŒ Gemini APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚Secretsã«`GEMINI_API_KEY`ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚")
                    else:
                        progress = st.progress(0)
                        ai_results = []
                        
                        for i, stock in enumerate(top_picks):
                            ticker = stock['ticker']
                            progress.progress((i + 1) / len(top_picks))
                            st.text(f"åˆ†æä¸­: {ticker}... ({i+1}/{len(top_picks)})")
                            
                            # æ„Ÿæƒ…åˆ†æ
                            score, summary, _ = analyzer.get_sentiment(ticker)
                            
                            # MLäºˆæ¸¬ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
                            pred = predictor._simple_prediction(
                                pd.DataFrame({'close': [stock['price']], 'rsi': [stock.get('rsi', 50)], 'ema_200': [stock['price']]}),
                                score
                            )
                            
                            ai_results.append({
                                'ticker': ticker,
                                'name': stock['name'],
                                'price': stock['price'],
                                'rsi': stock.get('rsi'),
                                'ai_score': score,
                                'ai_summary': summary,
                                'prediction': pred['direction']
                            })
                            
                            # ã€ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–ã€‘Geminiç„¡æ–™æ ã¯15 RPMï¼ˆ4ç§’ã«1å›ï¼‰
                            if i < len(top_picks) - 1:  # æœ€å¾Œä»¥å¤–ã¯å¾…æ©Ÿ
                                time.sleep(4.0)
                        
                        progress.empty()
                        
                        # === ç·åˆã‚¹ã‚³ã‚¢è¨ˆç®— ===
                        # ç·åˆã‚¹ã‚³ã‚¢ = (ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ç‚¹ Ã— 0.7) + (AIæ„Ÿæƒ…ç‚¹ Ã— 0.3) + ä¾¡æ ¼ãƒœãƒ¼ãƒŠã‚¹
                        for r in ai_results:
                            # å…ƒã®ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ã‚¹ã‚³ã‚¢ã‚’å–å¾—ï¼ˆtop_picksã‹ã‚‰ï¼‰
                            tech_score = next((s.get('tech_score', 50) for s in top_picks if s['ticker'] == r['ticker']), 50)
                            price_bonus = next((s.get('price_bonus', 0) for s in top_picks if s['ticker'] == r['ticker']), 0)
                            
                            # ç·åˆã‚¹ã‚³ã‚¢ = ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«Ã—0.7 + AIÃ—0.3 + ä¾¡æ ¼ãƒœãƒ¼ãƒŠã‚¹
                            r['tech_score'] = tech_score
                            r['price_bonus'] = price_bonus
                            r['total_score'] = (tech_score * 0.7) + (r['ai_score'] * 0.3) + price_bonus
                            
                            # ãƒ©ãƒ³ã‚¯æ›´æ–°
                            if r['total_score'] >= 80:
                                r['rank'] = "S"
                            elif r['total_score'] >= 60:
                                r['rank'] = "A"
                            elif r['total_score'] >= 40:
                                r['rank'] = "B"
                            else:
                                r['rank'] = "C"
                        
                        # ç·åˆã‚¹ã‚³ã‚¢é †ã«ã‚½ãƒ¼ãƒˆï¼ˆé«˜ã„ã»ã©è‰¯ã„ï¼‰
                        ai_results = sorted(ai_results, key=lambda x: x['total_score'], reverse=True)
                        
                        # AIåˆ†æçµæœã‚’è¡¨ç¤º
                        st.success("âœ… AIåˆ†æå®Œäº†ï¼ï¼ˆç·åˆã‚¹ã‚³ã‚¢ = ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«70% + AI30% + ä¾¡æ ¼ãƒœãƒ¼ãƒŠã‚¹ï¼‰")
                        st.caption("ã‚¹ã‚³ã‚¢ãŒé«˜ã„ã»ã©ã€Œå¥½ææ–™ Ã— å£²ã‚‰ã‚Œéã Ã— å‰²å®‰ã€ã§è²·ã„æ¨å¥¨")
                        
                        for rank, result in enumerate(ai_results, 1):
                            col1, col2, col3, col4 = st.columns([0.5, 2, 1, 1.5])
                            
                            with col1:
                                # ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
                                medals = {1: "ğŸ¥‡", 2: "ğŸ¥ˆ", 3: "ğŸ¥‰"}
                                if rank in medals:
                                    st.markdown(f"### {medals[rank]}")
                                else:
                                    st.markdown(f"**{rank}**")
                            
                            with col2:
                                rank_badge = result.get('rank', 'C')
                                st.write(f"**[{rank_badge}] {result['ticker']}** - {result['name']}")
                                st.caption(f"Â¥{result['price']:,.0f} / RSI: {result['rsi']:.1f} / ç·åˆ: {result['total_score']:.1f}ç‚¹")
                            
                            with col3:
                                score_color = "ğŸŸ¢" if result['ai_score'] >= 70 else "ğŸ”´" if result['ai_score'] <= 30 else "ğŸŸ¡"
                                st.metric(f"{score_color} AI", f"{result['ai_score']}")
                            
                            with col4:
                                # è©³ç´°åˆ†æãƒœã‚¿ãƒ³
                                if st.button(f"ğŸ“Š è©³ç´°åˆ†æ", key=f"ai_detail_{result['ticker']}"):
                                    st.session_state.selected_ticker = result['ticker']
                                    st.session_state.go_to_signal = True
                                    st.rerun()
                            
                            st.divider()
                        
                except ImportError as e:
                    st.error(f"âŒ AIæ©Ÿèƒ½ã«å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“: {e}")
                except Exception as e:
                    st.error(f"âŒ AIåˆ†æã‚¨ãƒ©ãƒ¼: {e}")
    else:
        st.info("ğŸ‘† ã€Œã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°é–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚¹ã‚­ãƒ£ãƒ³ã‚’é–‹å§‹ã—ã¦ãã ã•ã„")
        
        # å¯¾è±¡éŠ˜æŸ„ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        with st.expander("ğŸ“‹ å¯¾è±¡éŠ˜æŸ„ä¸€è¦§", expanded=False):
            st.markdown("æ¥½å¤©è¨¼åˆ¸ã‹ã¶ãƒŸãƒ‹å¯¾å¿œã®ä¸»è¦éŠ˜æŸ„ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¾ã™ï¼š")
            cols = st.columns(4)
            for i, ticker in enumerate(RAKUTEN_MINI_STOCKS[:20]):
                cols[i % 4].caption(ticker)
            if len(RAKUTEN_MINI_STOCKS) > 20:
                st.caption(f"...ä»– {len(RAKUTEN_MINI_STOCKS) - 20} éŠ˜æŸ„")


def render_stock_card(stock: Dict, show_signal: bool = True):
    """éŠ˜æŸ„ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º"""
    with st.container():
        col1, col2, col3, col4, col5 = st.columns([2, 1, 1, 0.8, 1])
        
        with col1:
            if show_signal and stock.get('signal'):
                icon = "ğŸŸ¢" if stock['signal'] == "è²·ã„" else "ğŸ”´"
                st.markdown(f"### {icon} {stock['ticker']}")
            else:
                st.markdown(f"### â³ {stock['ticker']}")
            st.caption(stock['name'])
        
        with col2:
            st.metric("æ ªä¾¡", f"Â¥{stock['price']:,.0f}")
        
        with col3:
            st.metric("RSI", f"{stock['rsi']:.1f}" if stock.get('rsi') else "-")
        
        with col4:
            # ãƒ©ãƒ³ã‚¯è¡¨ç¤º
            rank = stock.get('rank', 'C')
            rank_icons = {"S": "ğŸ†", "A": "ğŸ¥‡", "B": "ğŸ¥ˆ", "C": "ğŸ¥‰"}
            st.metric("ãƒ©ãƒ³ã‚¯", f"{rank_icons.get(rank, '')} {rank}")
        
        with col5:
            if show_signal and stock.get('signal'):
                st.success(f"**{stock['signal']}**")
                st.caption(stock['trigger'])
            elif stock.get('setup'):
                st.info(f"**{stock['setup']}**")
            else:
                st.caption(stock['trend'])
        
        # è©³ç´°åˆ†æã¸ã®ãƒªãƒ³ã‚¯
        if st.button(f"ğŸ“Š è©³ç´°åˆ†æ", key=f"analyze_{stock['ticker']}"):
            st.session_state.selected_ticker = stock['ticker']
            st.session_state.go_to_signal = True
            st.rerun()
        
        st.divider()
